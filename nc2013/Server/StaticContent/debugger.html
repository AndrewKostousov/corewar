<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title>Core War Debugger</title>
	<script src="jquery-1.7.2.js"></script>
	<script src="angular.min.js"></script>
	<script src="bootstrap.min.js"></script>
	<link rel="stylesheet" href="bootstrap/bootstrap.css" />
	<script src="common.js"></script>
	<script src="base.js"></script>
	<script src="server.js"></script>
	<script src="game.js"></script>
	<script src="memory.js"></script>
	<script src="program.js"></script>
	<script type="text/javascript">

		var gameRunner;
		$(function () {
			$("#programsTab").click(switchToProgramsTab);
			$("#debuggerTab").click(switchToDebuggerTab);

			$("#stepCount").keydown(function (event) {
				if (event.which == 13)
					step();
			});

			var memory = new Memory({
				$map: $("#map"),
				$listing: $("#listing"),
				cellCount: 8000
			});
			var programs = [];
			programs.push(new ProgramState({
				memory: memory,
				$processCount: $("#processCountA"),
				$last: $("#lastCommandA"),
				$next: $("#nextCommandA"),
				$win: $("#programAWinner"),
				$source: $("#programA")
			}));
			programs.push(new ProgramState({
				memory: memory,
				$processCount: $("#processCountB"),
				$last: $("#lastCommandB"),
				$next: $("#nextCommandB"),
				$win: $("#programBWinner"),
				$source: $("#programB")
			}));
			var game = new Game({
				$currentStep: $("#currentStep"),
				programs: programs,
				memory: memory
			});
			gameRunner = new GameRunner({
				game: game,
				onGameStarted: gameStarted,
				onGameError: showGameError,
				onGameRunStatusChanged: gameRunStatusChanged
			});
			gameRunner.load();

			$listing = $("#listing");
			var resizeCounter = 0;
			$(window).resize(function () {
				var counter = ++resizeCounter;
				setTimeout(function () {
					if (counter == resizeCounter)
						adjustLayout();
				}, 100);
			});
			adjustLayout();
		});

		var $listing;
		var minDebuggerHeight = 400;
		var oldDebuggerHeight;
		function adjustLayout() {
			var newHeight = $(window).height() - $listing.position().top - 20;
			if (newHeight < minDebuggerHeight)
				newHeight = minDebuggerHeight;
			if (oldDebuggerHeight != newHeight) {
				oldDebuggerHeight = newHeight;
				$listing.height(newHeight);
			}
		}

		function gameStarted() {
			showGameError(null);
			switchToDebuggerTab();
		}

		function gameRunStatusChanged(gameRunStatus) {
			$(".debugger-gameRunStatus").removeClass("playing");
			$(".debugger-gameRunStatus").removeClass("loading");
			$(".debugger-gameRunStatus").removeClass("gameover");
			$(".debugger-gameRunStatus").addClass(gameRunStatus);
		}

		function showGameError(err) {
			if (err) {
				$("#error-message").text(err);
				$("#error-message").removeClass("hidden");
			}
			else {
				$("#error-message").text("");
				$("#error-message").addClass("hidden");
			}
		}

		function switchToProgramsTab() {
			$("#programsTab").addClass("active");
			$("#programsPanel").addClass("active");
			$("#debuggerTab").removeClass("active");
			$("#debuggerPanel").removeClass("active");
		}

		function switchToDebuggerTab() {
			$("#debuggerTab").addClass("active");
			$("#debuggerPanel").addClass("active");
			$("#programsTab").removeClass("active");
			$("#programsPanel").removeClass("active");
			adjustLayout();
		}

		var fastSpeed = 16;
		var slowSpeed = 1;

		function step() {
			var stepCount = parseInt($("#stepCount").val());
			if (!stepCount)
				stepCount = 1;
			gameRunner.step(stepCount);
		}

	</script>
	<style>
		.debugger-programs {
			width: 100%;
		}

			.debugger-programs td {
				vertical-align: top;
			}

			.debugger-programs textarea.program {
				width: 100%;
				font-family: monospace;
				min-height: 300px;
			}

		.debugger-map .mapCell {
			background-color: black;
			float: left;
			width: 5px;
			height: 5px;
		}

			.debugger-map .mapCell.Data {
				background-color: black;
			}

			.debugger-map .mapCell.Command.modified0 {
				background-color: darkorange;
			}

			.debugger-map .mapCell.Data.modified0 {
				background-color: black;
				border: 1px darkorange solid;
			}

			.debugger-map .mapCell.Command.modified1 {
				background-color: lightgreen;
			}

			.debugger-map .mapCell.Data.modified1 {
				background-color: black;
				border: 1px lightgreen solid;
			}

		.debugger-winnerState .winner-info {
			display: none;
			background-color: palegreen;
			padding: 2px 10px 2px 10px;
			border-radius: 3px;
		}

		.debugger-winnerState .draw-info {
			display: none;
			background-color: yellow;
			padding: 2px 10px 2px 10px;
			border-radius: 3px;
		}

		.debugger-winnerState.winner .winner-info, .debugger-winnerState.draw .draw-info {
			display: inline-block;
		}

		.debugger-listing {
			overflow-y: scroll;
		}

			.debugger-listing .listingItem {
				font-family: monospace;
			}

				.debugger-listing .listingItem.modified0 {
					background-color: darkorange;
				}

				.debugger-listing .listingItem.modified1 {
					background-color: lightgreen;
				}

		.debugger-mapContainer {
			padding-right: 50px;
		}

		.debugger-listingContainer {
			border: solid black 1px;
		}

		.debugger-tabs {
			border-bottom: lightgrey solid 10px;
			margin-bottom: 20px;
		}

		.debugger-tab {
			padding: 5px 15px 5px 15px;
			display: inline-block;
			font-size: larger;
			cursor: pointer;
		}

			.debugger-tab.active {
				background-color: lightgrey;
				cursor: default;
			}

		.debugger-panel {
			display: none;
		}

			.debugger-panel.active {
				display: block;
			}

		.debugger-panel-layout {
			width: 100%;
			min-width: 600px;
		}

			.debugger-panel-layout .left {
				vertical-align: top;
			}

			.debugger-panel-layout .right {
				vertical-align: top;
				width: 200px;
			}

		.debugger-section-title {
			font-size: larger;
			font-weight: bolder;
		}

			.debugger-section-title.second {
				padding-top: 20px;
			}

		.debugger-section-subtitle {
			padding-top: 10px;
			font-weight: bolder;
		}

		.debugger-buttons {
			padding-bottom: 20px;
		}

		.programInfoContainer .command {
			font-family: monospace;
		}

		.debugger-error {
			color: #b94a48;
			background-color: #f2dede;
			border-color: #eed3d7;
			border-radius: 5px;
			padding: 5px 10px 5px 10px;
			display: inline-block;
		}

		.debugger-gameRunStatus.playing .debugger-gameRunStatus-playing,
		.debugger-gameRunStatus.loading .debugger-gameRunStatus-loading,
		.debugger-gameRunStatus.gameover .debugger-gameRunStatus-gameover {
			display: inline-block;
		}

		.debugger-gameRunStatus span {
			position: relative;
			padding: 5px 10px 5px 10px;
			border-radius: 5px;
			font-size: 16px;
			top: -3px;
		}

		.debugger-gameRunStatus .debugger-gameRunStatus-playing {
			display: none;
			background-color: lightgreen;
		}

		.debugger-gameRunStatus .debugger-gameRunStatus-loading {
			display: none;
			background-color: lightpink;
		}

		.debugger-gameRunStatus .debugger-gameRunStatus-gameover {
			display: none;
			background-color: yellow;
		}
	</style>
</head>
<body>
	<div class="container">
		<script>nav()</script>
		<div class="page-header">
			<h1>
				Debugger
				<span class="debugger-gameRunStatus loading">
					<span class="debugger-gameRunStatus-playing">playing</span>
					<span class="debugger-gameRunStatus-gameover">game over</span>
					<span class="debugger-gameRunStatus-loading">loading, please wait...</span>
				</span>
			</h1>
		</div>
		<div class="debugger-buttons">
			<button title="Run without debugger" onclick="gameRunner.stepToEnd()">>>></button>
			<button title="Run fast" onclick="gameRunner.run(fastSpeed)">>></button>
			<button title="Run slow" onclick="gameRunner.run(slowSpeed)">></button>
			<button title="Pause" onclick="gameRunner.pause()">||</button>
			<button title="Reset" onclick="gameRunner.reset()">#</button>
			&nbsp;
			steps:
			<button onclick="gameRunner.step(-4)">-4</button>
			<button onclick="gameRunner.step(-2)">-2</button>
			<button onclick="gameRunner.step(-1)">-1</button>
			<button onclick="gameRunner.step(+1)">+1</button>
			<button onclick="gameRunner.step(+2)">+2</button>
			<button onclick="gameRunner.step(+4)">+4</button>
			&nbsp;
			<input type="text" value="+16" id="stepCount" />
			<button onclick="step()">go</button>
		</div>
		<div class="debugger-tabs">
			<div class="debugger-tab active" id="programsTab">Warriors</div>
			<div class="debugger-tab" id="debuggerTab">Debuger</div>
		</div>
		<div id="programsPanel" class="debugger-panel active">
			<table class="debugger-programs">
				<thead>
					<tr>
						<th>Program A</th>
						<th>Program B</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>
							<textarea class="program" id="programA"></textarea></td>
						<td>
							<textarea class="program" id="programB"></textarea></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div id="debuggerPanel" class="debugger-panel">
			<table class="debugger-panel-layout">
				<tr>
					<td class="left">
						<table>
							<col width="50%" />
							<col width="50%" />
							<tr>
								<td colspan="2">
									<div class="debugger-section-title">Memory</div>
									<div class="debugger-mapContainer">
										<div id="map" class="debugger-map"></div>
									</div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<div class="debugger-section-title second">Overview</div>
									<div>
										<span>Current Step: </span><span id="currentStep"></span>
									</div>
									<div id="error-message" class="debugger-error hidden"></div>
								</td>
							</tr>
							<tr>
								<td class="programInfoContainer">
									<div class="debugger-section-subtitle">Program A <span class="debugger-winnerState" id="programAWinner"><span class="winner-info">winner</span><span class="draw-info">draw</span></span></div>
									<div>
										<span>Processes: </span><span id="processCountA"></span>
										<div>
										</div>
										<span>Last: </span><span id="lastCommandA" class="command"></span>
										<div>
										</div>
										<span>Next: </span><span id="nextCommandA" class="command"></span>
									</div>
								</td>
								<td class="programInfoContainer">
									<div class="debugger-section-subtitle">Program B <span class="debugger-winnerState" id="programBWinner"><span class="winner-info">winner</span><span class="draw-info">draw</span></span></div>
									<div>
										<span>Processes: </span><span id="processCountB"></span>
										<div>
										</div>
										<span>Last: </span><span id="lastCommandB" class="command"></span>
										<div>
										</div>
										<span>Next: </span><span id="nextCommandB" class="command"></span>
									</div>
								</td>
							</tr>
						</table>
					</td>
					<td class="right">
						<div class="debugger-section-title">Listing</div>
						<div class="debugger-listingContainer">
							<div id="listing" class="debugger-listing"></div>
						</div>
					</td>
				</tr>
			</table>
		</div>
	</div>
</body>
</html>
